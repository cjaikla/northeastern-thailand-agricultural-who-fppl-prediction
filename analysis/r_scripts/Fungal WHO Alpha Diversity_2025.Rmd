---
title: "Fungi_WHO_PKK_Alpha_Div"
output: html_document
date: "12 April 2025"
---

```{r warning=FALSE, message=FALSE}
library(vegan)
library(plyr)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(phyloseq)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(data.table)
library(tidyr)
library(tidyverse)
```

###STEP1: Import ASV table for analysis using Phyloseq
```{r}
otus <- read.table("SakhonNakhonApril2025.final.txt",header=T,sep="\t",row.names=1)
otumat <- as(as.matrix(otus), "matrix")
OTU = otu_table(otumat, taxa_are_rows = TRUE)
```

###STEP2: Import taxonomy table for analysis using Phyloseq

```{r}
taxmat <- read.table("SakhonNakhonApril2025.taxonomy.fix.txt", header=T,sep="\t",row.names=1)
taxmat <- as(as.matrix(taxmat),"matrix")
TAX = tax_table(taxmat)
```


###STEP3: Import mapping file for analysis using Phyloseq

1.Check mapping file before import to R, R will automatically change sample name that starts with number or contain “-” in sample name. If you get error in this step, you should check sample name first. 

2.First column of first row should not start with #, R will not read the first row that starts with #

3. You can choose which samples to include in analysis by indicating specific group in the column

```{r}
meta = read.table("SakhonNakhonApril2025.mapping_file.txt",header=TRUE,row.names=1,sep="\t",stringsAsFactors=FALSE)
```

Check if your metadata file has been import successfully and correctly, the output will show a table of your metadata file (mapping file). *If you do not have header, you might start your first row with # (remove # and reload your mapping file).


```{r}
head(meta)
```

Construct sample_data-class using imported metadata
```{r warning=FALSE}
sampleData <- sample_data(meta)
```


###STEP4: Construct Phyloseq object
To construct phyloseq object, otu table, taxonomy table, and sampleData are required. Phylogenetic tree can be included, but it is not necessary for constructing phyloseq object.
Construct Phyloseq object called "Physeq"

```{r warning=FALSE}
physeq = phyloseq(OTU,TAX,sampleData)
```

```{r warning=FALSE}
physeq
```

```{r}
physeq = subset_taxa(physeq, Kingdom == "Fungi")
physeq
```
#Selecting the WHO FPPL
```{r }
#critical group #non of the critical fungi was detected
#physeq.1 = subset_taxa(physeq, Species == "Cryptococcus neoformans")
#physeq.2 = subset_taxa(physeq, Species == "Candida auris")
physeq.3 = subset_taxa(physeq, Species == "Aspergillus fumigatus")
#physeq.4 = subset_taxa(physeq, Species == "Candida albicans")
#physeq.100 = subset_taxa(physeq, Genus == "Candida")

#High group #only candida tropicalis
#physeq.5 = subset_taxa(physeq, Species == "Nakaseomyces glabrata")
#physeq.6 = subset_taxa(physeq, Genus == "Histoplasma")
#physeq.7 = subset_taxa(physeq, Species == "Candida tropicalis")
#physeq.8 = subset_taxa(physeq, Species == "Candida parapsilosis")
#physeq.17 = subset_taxa(physeq, Genus == "Madurella")
#physeq.18 = subset_taxa(physeq, Species == "Falciformispora senegalensis")
#physeq.19 = subset_taxa(physeq, Species == "Curvularia lunata")
#physeq.20 = subset_taxa(physeq, Species == "Zopfia rosatii")
physeq.21 = subset_taxa(physeq, Genus == "Acremonium")
physeq.22 = subset_taxa(physeq, Genus == "Fusarium")

#Mucorales
#physeq.23 = subset_taxa(physeq, Order == "Mucorales")
physeq.23 = subset_taxa(physeq, Genus == "Rhizopus")
#physeq.24 = subset_taxa(physeq, Genus == "Mucor")
#physeq.25 = subset_taxa(physeq, Genus == "Lichtheimia")

#Medium group
physeq.9 = subset_taxa(physeq, Genus == "Scedosporium")
#physeq.10 = subset_taxa(physeq, Species == "Lomentospora prolificans")
#physeq.11 = subset_taxa(physeq, Genus == "Coccidioides")
#physeq.12 = subset_taxa(physeq, Species == "Pichia kudriavzevii")
#physeq.13 = subset_taxa(physeq, Species == "Cryptococcus gattii")
#physeq.14 = subset_taxa(physeq, Species == "Talaromyces marneffei")
#physeq.15 = subset_taxa(physeq, Species == "Pneumocystis jirovecii")
#physeq.16 = subset_taxa(physeq, Genus == "Paracoccidioides")
```


```{r}
# Critical group: Candida albicans - High group: Acremonium, Fusarium, Mucorales - Medium group: Scedosporium, Pichia kudriavzevii
physeq.merge = merge_phyloseq(physeq.3, physeq.9, physeq.21, physeq.22, physeq.23)

physeq.merge
```


```{r}
sample_data(physeq.merge)$crop = factor(sample_data(physeq.merge)$crop, levels = c('Rubber_tree_A', 'Rubber_tree_B', 'Cassava', 'Sugarcane'))

```


```{r}
alpha.diversity = estimate_richness(physeq.merge, measures = c("Observed"))
data.anova = cbind(sample_data(physeq.merge), alpha.diversity)
physeq.anova = aov(Observed ~ crop, data.anova)
summary(physeq.anova)
```

#Alpha diversity by condition

```{r}
physeq.plot.richness.condition = plot_richness(physeq.merge, x = "crop", color=("crop"), measures=c("Observed")) + 
  geom_boxplot(lwd=0.5) + ggtitle("SakonNakhon WHO-FPPL Alpha Diversity by crop") + 
  stat_compare_means(method = "anova", label.y = 30, label.x = 0.65) + 
  theme_pubr(border= TRUE, legend = c("none")) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_colour_hue(l = 58) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) #+
  #geom_text(data=LABELS, aes(x=LABELS$zone, y = LABELS$ylabel , label = LABELS$Letters))

physeq.plot.richness.condition
```


```{r warning=FALSE}
#tiff("C:/Users/Syahriar Nur/OneDrive/Dokumen/R/R data/KKproject/Real data/D_alpha diversity/Alpha diversity Observe Order.tif",units = "in",  width = 7.5, height = 6.5, res = 800)
#physeq.plot.richness.condition
#dev.off()
```

###Statistical Analysis
```{r}
tukey.ps = TukeyHSD(x=physeq.anova, 'crop', conf.level = 0.95)

generate_label_df <- function(tukey.ps, variable){
 
     # Extract labels and factor levels from Tukey post-hoc 
     Tukey.levels <- tukey.ps[[variable]][,4]
     Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
     
     #I need to put the labels in the same order as in the boxplot :
     Tukey.labels$treatment=rownames(Tukey.labels)
     Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
     return(Tukey.labels)
     }

LABELS=generate_label_df(tukey.ps, 'crop')
names(LABELS) = c('Letters','crop')
```



```{r}
LABELS
```



```{r}
ylabel <- data.frame("ylabel" = c(19, 27, 21, 23)) #LAC surface
#ylabel <- data.frame("ylabel" = c(340, 400, 340, 380, 290,  460, 510, 590, 460,  350)) #CLC surface
```



```{r}
LABELS$ylabel<-ylabel$ylabel
```



```{r}
physeq.plot.richness.crop = plot_richness(physeq.merge, x="crop", color=("crop"), measures=c("Observed")) + 
  geom_boxplot(lwd=0.5) + ggtitle("SakonNakhon2025 WHO-FPPL Alpha Diversity by crop") + 
  annotate("text", x = 0.98, y = 30, label = "paste('ANOVA, ', italic('p'), ' = 0.0593')", parse = TRUE, size = 3.5) + 
  theme_pubr(border= TRUE, legend = c("none")) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_colour_hue(l = 58) +
  theme(axis.text.x = element_text(size=12, angle = , hjust = ), axis.text.y = element_text(size=12, angle = , hjust = ), axis.title.x = element_text(size = 16), axis.title.y = element_text(size = 16)) +
  geom_text(data=LABELS, aes(x=LABELS$crop, y = LABELS$ylabel , label = LABELS$Letters))
physeq.plot.richness.crop
```

#Save to Tiff file
```{r warning=FALSE}
tiff("WHOFPPL Alpha diversity 2025 CROP.tif",units = "in",  width = 6.5, height = 4.5, res = 1000)
physeq.plot.richness.crop
dev.off()
```


#Save to Png file
```{r warning=FALSE}
png("WHOFPPL Alpha diversity 2025 CROP.png", units = "in",  width = 6.5, height = 4.5, res = 1000)
physeq.plot.richness.crop
dev.off()
```
