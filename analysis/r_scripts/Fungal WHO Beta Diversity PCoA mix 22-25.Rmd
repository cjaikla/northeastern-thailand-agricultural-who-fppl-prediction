---
title: "Beta diversity PCoA mix"
author: "Niar Ibrahim"
date: "Updated 17 September 2025"
output:
  word_document: default
  html_document: default
  pdf_document: default
---
```{r}
install.packages(
  "microViz",
  repos = c(davidbarnett = "https://david-barnett.r-universe.dev", getOption("repos"))
)
```



#Load Packages
```{r warning=FALSE, message=FALSE}
library(ape)
library(vegan)
library(plyr)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(phyloseq)
library(magrittr)
library(ggplot2)
library(ggpubr)
library(data.table)
library(tidyr)
library(tidyverse)
library(ggforce)
library(microViz)
```

#### 2022 DATA ####

###STEP1: Import ASV table for analysis using Phyloseq
```{r}
otus <- read.table("SakhonITS.mixotu_2022.txt",header=T,sep="\t",row.names=1)
otumat <- as(as.matrix(otus), "matrix")
OTU = otu_table(otumat, taxa_are_rows = TRUE)
```

###STEP2: Import taxonomy table for analysis using Phyloseq

```{r}
taxmat <- read.table("SakhonITS.mixtaxonomy_2022.txt", header=T,sep="\t",row.names=1)
taxmat <- as(as.matrix(taxmat),"matrix")
TAX = tax_table(taxmat)
```

###STEP3: Import mapping file for analysis using Phyloseq

1.Check mapping file before import to R, R will automatically change sample name that starts with number or contain ‚Äú-‚Äù in sample name. If you get error in this step, you should check sample name first. 

2.First column of first row should not start with #, R will not read the first row that starts with #

3. You can choose which samples to include in analysis by indicating specific group in the column

```{r}
meta = read.table("SakhonITS.mixmapping_file_2022.txt",header=TRUE,row.names=1,sep="\t",stringsAsFactors=FALSE)
```


Construct sample_data-class using imported metadata
```{r warning=FALSE}
sampleData_2022 <- sample_data(meta_2022)
```


```{r warning=FALSE}
physeq_2022 = phyloseq(OTU_2022,TAX_2022,sampleData_2022)
physeq_2022
```


```{r}
physeq_2022 <- subset_taxa(physeq_2022, Kingdom == "Fungi")
physeq_2022
```





#### 2025 DATA ####

```{r}
otus_2025 <- read.table("SakhonNakhonApril.mixotu_2025.txt",header=T,sep="\t",row.names=1)
otumat_2025 <- as(as.matrix(otus_2025), "matrix")
OTU_2025 = otu_table(otumat_2025, taxa_are_rows = TRUE)
```

```{r}
taxmat_2025 <- read.table("SakhonNakhonApril.mixtaxonomy_2025.txt", header=T,sep="\t",row.names=1)
taxmat_2025 <- as(as.matrix(taxmat_2025),"matrix")
TAX_2025 = tax_table(taxmat_2025)
```


```{r}
meta_2025 = read.table("SakhonNakhonApril.mixmapping_file_2025.txt",header=TRUE,row.names=1,sep="\t",stringsAsFactors=FALSE)
```


Construct sample_data-class using imported metadata
```{r warning=FALSE}
sampleData_2025 <- sample_data(meta_2025)
```


```{r warning=FALSE}
physeq_2025 = phyloseq(OTU_2025,TAX_2025,sampleData_2025)
physeq_2025
```


```{r}
physeq_2025 <- subset_taxa(physeq_2025, Kingdom == "Fungi")
physeq_2025
```


```{r}
taxa_names(physeq_2022) <- paste0("Y2022_", taxa_names(physeq_2022))
taxa_names(physeq_2025) <- paste0("Y2025_", taxa_names(physeq_2025))
```


```{r}
colnames(sample_data(physeq_2022)) <- tolower(colnames(sample_data(physeq_2022)))
colnames(sample_data(physeq_2025)) <- tolower(colnames(sample_data(physeq_2025)))
```




# Combine 2022+2025
```{r}
physeq_combined <- merge_phyloseq(physeq_2025, physeq_2022)
```

```{r}
physeq_combined <- subset_taxa(physeq_combined, Kingdom == "Fungi")
physeq_combined
```


#Selecting the WHO FPPL
```{r }
# Select WHO FPPL taxa
physeq_list <- list(
  subset_taxa(physeq_combined, Species == "Aspergillus fumigatus"),
  subset_taxa(physeq_combined, Species == "Candida tropicalis"),
  subset_taxa(physeq_combined, Species == "Falciformispora senegalensis"),
  subset_taxa(physeq_combined, Species == "Curvularia lunata"),
  subset_taxa(physeq_combined, Genus == "Acremonium"),
  subset_taxa(physeq_combined, Genus == "Fusarium"),
  subset_taxa(physeq_combined, Order == "Mucorales"),
  subset_taxa(physeq_combined, Genus == "Rhizopus"),
  subset_taxa(physeq_combined, Genus == "Mucor"),
  subset_taxa(physeq_combined, Genus == "Lichtheimia"),
  subset_taxa(physeq_combined, Genus == "Scedosporium"),
  subset_taxa(physeq_combined, Species == "Talaromyces marneffei")
)
```


```{r }
# Merge all WHO FPPL subsets into one
physeq.merge <- do.call(merge_phyloseq, physeq_list)
```

```{r}
physeq.merge <- tax_glom(physeq.merge, taxrank = "Species", NArm = TRUE)
```


```{r}
physeq.merge <- physeq.merge %>%
  tax_fix(unknowns = c("uncultured", "NA", "Unclassified"))
tax_table(physeq.merge)[, "Species"] <- gsub("\\.\\d+$", "", tax_table(physeq.merge)[, "Species"])
```



```{r}
sample_data(physeq.merge)$crop
```

```{r}
sample_data(physeq.merge)$crop = factor(sample_data(physeq.merge)$crop, levels = c('Rubber_tree_A_2025', 'Rubber_tree_A_2022', 'Rubber_tree_B_2025', 'Rubber_tree_B_2022', 'Cassava_2025', 'Cassava_2022', 'Sugarcane_2022', 'Sugarcane_2022'))

```


```{r}
duplicated(tax_table(physeq.merge)[, "Species"]) %>% sum()
```

```{r}
dup_species <- tax_table(physeq.merge)[, "Species"] %>%
  as.character() %>%
  {.[duplicated(.)]}
dup_species
```


```{r}
tax_table(physeq.merge)[tax_table(physeq.merge)[, "Species"] %in% dup_species, ]

```


```{r}
tax_table(physeq.merge)[, "Species"] <- make.unique(as.character(tax_table(physeq.merge)[, "Species"]))
```


```{r}
# üîπ Keep only taxa that appear in at least one sample (non-zero total abundance)
physeq.merge <- prune_taxa(taxa_sums(physeq.merge) > 0, physeq.merge)
```



```{r}
# ----------------------------
# 1Ô∏è‚É£ CLR Transformation (Aitchison)
# ----------------------------
physeq.clr <- phyloseq::transform_sample_counts(physeq.merge, function(x) x + 1) %>%
  microViz::tax_transform("clr", rank = "Species")
```


```{r}
# ----------------------------
# 2Ô∏è‚É£ PCoA Ordination (Euclidean)
# ----------------------------
ord_clr <- ordinate(physeq.clr, method = "PCoA", distance = "euclidean")
```


```{r}
# ----------------------------
# 3Ô∏è‚É£ Prepare data for plotting
# ----------------------------
plot_df <- as.data.frame(ord_clr$vectors)
plot_df$SampleID <- rownames(plot_df)
```


```{r}
meta_df <- data.frame(sample_data(physeq.clr))
meta_df$SampleID <- rownames(meta_df)
```


```{r}
# Merge metadata and ordination
meta_df_clean <- meta_df[, !duplicated(colnames(meta_df))]
plot_df <- merge(plot_df, meta_df_clean, by = "SampleID", all.x = TRUE)
```


```{r}
# ‚úÖ Ensure crop column exists
if (!"crop" %in% colnames(plot_df)) stop("No 'crop' column found in metadata!")
```


```{r}
# ----------------------------
# 4Ô∏è‚É£ PERMANOVA (Aitchison distance)
# ----------------------------
dist_euc <- phyloseq::distance(physeq.clr, method = "euclidean")
set.seed(123)
permanova <- adonis2(dist_euc ~ crop, data = plot_df)
p_value <- format(permanova$`Pr(>F)`[1], digits = 3)
```


```{r}
# ----------------------------
# 5Ô∏è‚É£ Define custom crop colors
# ----------------------------
crop_colors <- c(
  "Rubber_tree_A_2022" = "salmon",
  "Rubber_tree_A_2025" = "salmon4",
  "Rubber_tree_B_2022" = "lawngreen",
  "Rubber_tree_B_2025" = "darkgreen",
  "Cassava_2022"       = "cyan",
  "Cassava_2025"       = "darkcyan",
  "Sugarcane_2022"     = "orchid",
  "Sugarcane_2025"     = "darkmagenta"
)
```


```{r}
# ----------------------------
# 6Ô∏è‚É£ PCoA Plot with colored ellipses and p-value
# ----------------------------

p_clr <- ggplot(plot_df, aes(Axis.1, Axis.2, color = crop)) +
  geom_point(size = 3, alpha = 0.9)  +

  stat_ellipse(
    level = 0.95,
    linetype = 2,
    linewidth = 1,
    alpha = 0.8,
    show.legend = FALSE
  ) +

  ggforce::geom_mark_hull(
    aes(fill = crop, group = crop),
    alpha = 0.15,
    show.legend = FALSE,
    expand = unit(2, "mm"),
    concavity = 3
  ) +

  ggtitle("PCoA (Aitchison CLR) of WHO FPPL 27 species") +
  annotate(
    "text",
    label = "bold(paste('PERMANOVA, ', italic('p'), ' = 0.001'))",
    parse = TRUE, 
    size = 3,
    hjust = 0,
    vjust = 1,
    x = min(plot_df$Axis.1) * 0.9,
    y = max(plot_df$Axis.2) * 1.5,
  ) +

  scale_color_manual(values = crop_colors) +
  scale_fill_manual(values = crop_colors) +
  coord_equal() +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    legend.background = element_rect(fill = "white", color = NA),
    legend.key.size = unit(0.6, "cm"),
    legend.title = element_text(face = "bold", size = 11),
    legend.text = element_text(size = 10),
    plot.title = element_text(size = 13, face = "plain", hjust = 0.5),  # ‚Üê changed here
    axis.title = element_text(face = "bold", size = 13),
    axis.text = element_text(size = 11, color = "black"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.8),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "grey90", linewidth = 0.4)
  ) +
  labs(
    x = "Axis 1",
    y = "Axis 2",
    color = "Crop"
  )

p_clr
```

# Save to jpeg
```{r warning=FALSE}
jpeg("D:/OneDrive/Dokumen/R/R data/SakonNakhon/Abundance - Distribution/WHOFPPL Beta diversity PCoA-Species-Aitchison MIX2022-2025.jpeg",units = "in",  width = 6, height = 6, res = 1000)
p_clr
dev.off()
```


# Checking total taxa included

```{r}
# Convert to dataframe
clr_df <- speedyseq::psmelt(physeq.clr)

# Count unique species per crop
clr_species_per_crop <- clr_df %>%
  dplyr::group_by(crop) %>%
  dplyr::summarize(n_species = dplyr::n_distinct(Species))

clr_species_per_crop
```

```{r}
ntaxa(physeq.clr)
```

